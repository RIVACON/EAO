

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Discrete supply decisions - example battery in continuous intraday markets &mdash; EAO  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=d2ebc91c" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Stochastic linear program (SLP) to take into account uncertainty" href="../stochastic_optimization/slp_sample.html" />
    <link rel="prev" title="Combined Heat and Power" href="../combined_heat_power/chp_sample.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/EAO_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../eao.html">EAO package</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../samples.html">Samples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../samples.html#simple-start-optimizing-power-consumption-with-battery-pv">Simple start: Optimizing power consumption with battery &amp; PV</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../samples.html#green-ppa-and-structured-downstream-contract">Green PPA and structured downstream contract</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../samples.html#illustration-small-power-and-heat-network-in-german">Illustration: Small power and heat network (in German)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../samples.html#id1">Green PPA and structured downstream contract</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../samples.html#marginal-costs-in-portfolio-optimization">Marginal costs in portfolio optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../samples.html#multi-commodity-optimization">Multi commodity optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../samples.html#split-optimization-to-speed-up-large-problems">Split optimization (to speed up large problems)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../samples.html#combined-heat-and-power">Combined Heat and Power</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../samples.html#battery-optimization-against-an-order-book">Battery optimization against an order book</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Discrete supply decisions - example battery in continuous intraday markets</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Some-prerequisites">Some prerequisites</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Setup-(1)-Basics">Setup (1) Basics</a></li>
<li class="toctree-l4"><a class="reference internal" href="#(2)-Order-book">(2) Order book</a></li>
<li class="toctree-l4"><a class="reference internal" href="#(3)-Assets">(3) Assets</a></li>
<li class="toctree-l4"><a class="reference internal" href="#(4)-Setting-up-the-portfolio">(4) Setting up the portfolio</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Perform-the-optimization">Perform the optimization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Create-charts-and-interpret-the-results">Create charts and interpret the results</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../samples.html#stochastic-linear-programs">Stochastic Linear Programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../samples.html#robust-optimization">Robust optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../samples.html#parameter-handling">Parameter handling</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">EAO</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../samples.html">Samples</a></li>
      <li class="breadcrumb-item active">Discrete supply decisions - example battery in continuous intraday markets</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/samples/order_book/order_book_battery.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Discrete-supply-decisions---example-battery-in-continuous-intraday-markets">
<h1>Discrete supply decisions - example battery in continuous intraday markets<a class="headerlink" href="#Discrete-supply-decisions---example-battery-in-continuous-intraday-markets" title="Link to this heading"></a></h1>
<p>We often face discrete execution decisions in energy. Those may be shippings (e.g. LNG) or order books in futures markets. Another example are continuous intraday power or gas markets. Let us focus on the latter in this example of optimizing a battery directly against an intraday power order book.</p>
<p>Our example: The main market targeted by battery storage (besides reserve markets) is the power intraday market. When power prices are low, the battery is charged, to be discharded at higher power prices. When optimizing a battery against the intraday market, a typical simplification is to assume there is a price for each time interval (such as 15min in central Europe). Following this optimization, we pass the position to our autotrader, that targets to close the position at the assumed price
curve (or better, naturally).</p>
<p>This simplification is often good, but does not account for significant features if the market:</p>
<ul class="simple">
<li><p>Orders may have to be executed all or nothing. If orders are large as compared to the battery, this cannot be neglected</p></li>
<li><p>Bid ask spread. There may be a significant price gap between buying and selling</p></li>
<li><p>Limited liquidity. We may not be able to trade the full dispatch potential of the battery. Particularly for shallow markets and large assets this may have a significant effect</p></li>
</ul>
<p>Note how we consistently solve for an exact match between battery dispatch and order execution. If a direct link to an autotrader is established, this enables us to do a direct execution. Naturally there are many aspects to be accounted for in real life from this static demo to a live solution with a changing order and position tracker.</p>
<section id="Some-prerequisites">
<h2>Some prerequisites<a class="headerlink" href="#Some-prerequisites" title="Link to this heading"></a></h2>
<p>Import relevant packages and set links. Note that we set a random seed for the generation of our randomized order book.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">eaopack</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">eao</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">6924</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Setup-(1)-Basics">
<h2>Setup (1) Basics<a class="headerlink" href="#Setup-(1)-Basics" title="Link to this heading"></a></h2>
<p>Defining start, end and time grid. Here we optimize over a full day in an hourly granularity. That’s an artificial choice for sake of visual clarity, of course.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">node</span> <span class="o">=</span> <span class="n">eao</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="s1">&#39;power&#39;</span><span class="p">)</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">E</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">timegrid</span> <span class="o">=</span> <span class="n">eao</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">Timegrid</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="s1">&#39;h&#39;</span><span class="p">)</span> <span class="c1"># using hours for better visualization</span>
</pre></div>
</div>
</div>
</section>
<section id="(2)-Order-book">
<h2>(2) Order book<a class="headerlink" href="#(2)-Order-book" title="Link to this heading"></a></h2>
<p>As the first ingredient we generate a randomized order book with orders of various prices, capacities and duration</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create larger number of orders</span>
<span class="c1">## some time steps, buy &amp; sell</span>
<span class="n">ob</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="s1">&#39;capa&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">])</span> <span class="c1"># alternative to dict is DataFrame ... converted in asset</span>
<span class="n">r</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span> <span class="c1"># row</span>
<span class="c1">### orders</span>
<span class="c1"># orders with bid/ask spread on base signal</span>
<span class="c1"># base signal</span>
<span class="n">bs</span> <span class="o">=</span> <span class="p">(</span><span class="mi">30</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">timegrid</span><span class="o">.</span><span class="n">I</span><span class="o">/</span><span class="mi">24</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">40</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">timegrid</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
<span class="n">prices</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;av&#39;</span><span class="p">:</span> <span class="n">bs</span><span class="p">}</span>
<span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">timegrid</span><span class="o">.</span><span class="n">I</span><span class="p">:</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">timegrid</span><span class="o">.</span><span class="n">timepoints</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
    <span class="c1"># sell (they sell)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">r</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">tp</span>
        <span class="n">r</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">tp</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="s1">&#39;h&#39;</span><span class="p">)</span>
        <span class="n">r</span><span class="p">[</span><span class="s1">&#39;capa&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">r</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">bs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">ob</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ob</span><span class="p">)]</span> <span class="o">=</span> <span class="n">r</span>
    <span class="c1"># buy (they buy)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">r</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">tp</span>
        <span class="n">r</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">tp</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="s1">&#39;h&#39;</span><span class="p">)</span>
        <span class="n">r</span><span class="p">[</span><span class="s1">&#39;capa&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">r</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">bs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">ob</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ob</span><span class="p">)]</span> <span class="o">=</span> <span class="n">r</span>
<br/></pre></div>
</div>
</div>
<p>The artificial order book shown with their price against time of delivery. The thickness of the orders indicates their sice</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">rcdefaults</span><span class="p">()</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">tight_layout</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="c1">#out[&#39;dispatch&#39;].loc[:,&#39;battery&#39;].plot(ax = ax)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="n">ob</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;capa&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span>  <span class="p">:</span>  <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]],</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]],</span><span class="s1">&#39;b-&#39;</span><span class="p">,</span><span class="n">linewidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;capa&#39;</span><span class="p">]),</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;capa&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>  <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]],</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]],</span><span class="s1">&#39;r-&#39;</span><span class="p">,</span><span class="n">linewidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;capa&#39;</span><span class="p">]),</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Order book&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;EUR/MWh&#39;</span><span class="p">)</span>
<span class="c1"># for legend only</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">S</span><span class="p">,</span> <span class="n">S</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;b-&#39;</span><span class="p">,</span><span class="n">linewidth</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;sell&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">S</span><span class="p">,</span> <span class="n">S</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;r-&#39;</span><span class="p">,</span><span class="n">linewidth</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/samples_order_book_order_book_battery_8_0.png" src="../../_images/samples_order_book_order_book_battery_8_0.png" />
</div>
</div>
</section>
<section id="(3)-Assets">
<h2>(3) Assets<a class="headerlink" href="#(3)-Assets" title="Link to this heading"></a></h2>
<p>Order book: We utilize a specific asset in EAO to implement the behaviour of the order book. Note that the asset has a parameter “full_exec”. Setting it to False, the optimizer is allowed to execute parts of an order – and the optimization problem is continuous and thus very fast (on my laptop 1.4s). In reality most of the orders will still be executed fully due to the nature of the problem setup. If required, the parameter may be set to True, resulting in a more complex MIP as orders must be
executed fully (6.6s).</p>
<p>Battery: Our main asset is a battery storage. We choose artificial parameters such as 95% efficiency and a size of 40 MWh as compared to a capacity of 10 MW (a 4h battery). Note that we need to specifc a start and a target fill level.</p>
<p>Target fill level flex: The target fill level requires some additional thoughts. Left unpenalized, an optimizer will completely drain a battery at the end of the day (in case power prices are positive). In order to avoid this we need to define the value battery power has for us towards the end of the day. We do this by forcing the battery to be left at 50% fill level and adding an “extra source” for power with a market price above the order book. Power drawn from this “extra source” represents
battery usage from this 50% target fill level.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># order book asset</span>
<span class="n">order_book</span> <span class="o">=</span> <span class="n">eao</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">OrderBook</span><span class="p">(</span><span class="s1">&#39;orders&#39;</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span>
                                    <span class="n">orders</span>    <span class="o">=</span> <span class="n">ob</span><span class="p">,</span>
                                    <span class="n">full_exec</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1"># switch to enforce (or not) full order execution</span>

<span class="c1"># battery</span>
<span class="n">efficiency</span> <span class="o">=</span> <span class="mf">0.95</span>
<span class="n">battery</span> <span class="o">=</span> <span class="n">eao</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">Storage</span><span class="p">(</span><span class="s1">&#39;battery&#39;</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">cap_in</span>      <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                                        <span class="n">cap_out</span>     <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                                        <span class="n">start_level</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
                                        <span class="n">end_level</span>   <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
                                        <span class="n">eff_in</span>      <span class="o">=</span> <span class="n">efficiency</span><span class="p">,</span>
                                        <span class="n">size</span>        <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
                                        <span class="n">no_simult_in_out</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="c1"># at negative prices, we want to ensure the battery does not charge &amp; discharge at the same time to &quot;burn&quot; power</span>
<span class="c1"># last resort - battery end level. May allow battery not to be completely full, &quot;borrowing&quot; in last hours</span>
<span class="n">extra_power</span> <span class="o">=</span> <span class="n">eao</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">SimpleContract</span><span class="p">(</span><span class="s1">&#39;fill_level_adjust&#39;</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span>
                                <span class="n">max_cap</span>   <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                                <span class="n">min_cap</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="n">start</span>     <span class="o">=</span> <span class="n">timegrid</span><span class="o">.</span><span class="n">timepoints</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span>
                                <span class="n">end</span>       <span class="o">=</span> <span class="n">E</span><span class="p">,</span>
                                <span class="n">price</span>     <span class="o">=</span> <span class="s1">&#39;av&#39;</span><span class="p">,</span>
                                <span class="n">extra_costs</span> <span class="o">=</span> <span class="mi">20</span>
                                <span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="(4)-Setting-up-the-portfolio">
<h2>(4) Setting up the portfolio<a class="headerlink" href="#(4)-Setting-up-the-portfolio" title="Link to this heading"></a></h2>
<p>In EAO we can easily link all assets in a portfolio. By refering to the same node we ensure their dispatch sums to zero.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">portf</span> <span class="o">=</span> <span class="n">eao</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">Portfolio</span><span class="p">([</span><span class="n">battery</span><span class="p">,</span> <span class="n">order_book</span><span class="p">,</span> <span class="n">extra_power</span><span class="p">])</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="Perform-the-optimization">
<h1>Perform the optimization<a class="headerlink" href="#Perform-the-optimization" title="Link to this heading"></a></h1>
<p>Once the portfolio is set up, optimization can be called and the output extracted.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">op</span> <span class="o">=</span> <span class="n">portf</span><span class="o">.</span><span class="n">setup_optim_problem</span><span class="p">(</span><span class="n">prices</span><span class="o">=</span><span class="n">prices</span><span class="p">,</span> <span class="n">timegrid</span><span class="o">=</span><span class="n">timegrid</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">solver</span> <span class="o">=</span> <span class="s1">&#39;SCIP&#39;</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">eao</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">extract_output</span><span class="p">(</span><span class="n">portf</span><span class="o">=</span> <span class="n">portf</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Create-charts-and-interpret-the-results">
<h1>Create charts and interpret the results<a class="headerlink" href="#Create-charts-and-interpret-the-results" title="Link to this heading"></a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">rcdefaults</span><span class="p">()</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">tight_layout</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="n">ob</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;special&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">:</span> <span class="n">myal</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">myal</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="c1"># executed</span>
    <span class="k">if</span>   <span class="n">r</span><span class="p">[</span><span class="s1">&#39;capa&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]],</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]],</span><span class="s1">&#39;b-&#39;</span><span class="p">,</span><span class="n">linewidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;capa&#39;</span><span class="p">]),</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">myal</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;capa&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]],</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]],</span><span class="s1">&#39;r-&#39;</span><span class="p">,</span><span class="n">linewidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;capa&#39;</span><span class="p">]),</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">myal</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Executed orders&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;prices of orders EUR/MWh&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">S</span><span class="p">,</span> <span class="n">S</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;b-&#39;</span><span class="p">,</span><span class="n">linewidth</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;executed sell - we buy&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">S</span><span class="p">,</span> <span class="n">S</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;r-&#39;</span><span class="p">,</span><span class="n">linewidth</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;executed buy - we sell&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="c1">### show how to manually calculate fill level from dispatch</span>
<span class="c1"># fill_level = -out[&#39;dispatch&#39;].loc[:,&#39;battery&#39;]</span>
<span class="c1"># fill_level[fill_level&gt;0] *= efficiency</span>
<span class="c1"># fill_level = fill_level.cumsum()+20</span>
<span class="c1">### this is the automatic output</span>
<span class="n">fill_level</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;internal_variables&#39;</span><span class="p">][</span><span class="s1">&#39;battery_fill_level&#39;</span><span class="p">]</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fill_level</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;battery fill level&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;fill level battery in MWh&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/samples_order_book_order_book_battery_16_0.png" src="../../_images/samples_order_book_order_book_battery_16_0.png" />
</div>
</div>
<p>In bold color we can observe orders that have been executed. We have successfully combined a battery with a discrete order book consisting of orders that are partly overlapping and come with various prices and sizes.</p>
</section>


           </div>
          </div>
          <div role="contentinfo">
    <p>
        &copy 2025 - <a href="https://rivacon.com/impressum/">Impressum</a>
    </p>
</div>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>